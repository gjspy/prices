-- DROP TABLE Ratings;
-- DROP TABLE OfferHolders;
-- DROP TABLE Offers;
-- DROP TABLE Prices;
-- DROP TABLE ProductLinks;
-- DROP TABLE Labels;
-- DROP TABLE Images;
-- DROP TABLE Keywords;
-- DROP TABLE Products;
-- DROP TABLE Brands;

-- DELETE FROM Ratings; DELETE FROM OfferHolders; DELETE FROM Offers; DELETE FROM Prices; DELETE FROM ProductLinks; DELETE FROM Labels; DELETE FROM Images; DELETE FROM Keywords; DELETE FROM Products; DELETE FROM Brands;  -- 

-- CREATE TABLE Stores (
-- 	ID TINYINT UNSIGNED AUTO_INCREMENT NOT NULL,
-- 	SName TINYTEXT NOT NULL,
-- 	
-- 	PRIMARY KEY (ID),
-- 	UNIQUE (SName)
-- );

-- SELECT @@sql_mode, @@GLOBAL.sql_mode
-- add to ^ 'EMPTY_STRING_IS_NULL'

CREATE TABLE Brands (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	BName TINYTEXT NOT NULL,
	StoreID TINYINT UNSIGNED, -- TODO another admin task, dedupe these. use to differentiate own brand eg "essentials"
	ParentID INT UNSIGNED,
	IsOwnBrand BOOL,

	PRIMARY KEY (ID),
	FOREIGN KEY (ParentID) REFERENCES Brands(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (BName, StoreID)
);

ALTER TABLE Brands ADD FULLTEXT(BName);


CREATE TABLE Products (
	PID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PName TINYTEXT NOT NULL,
	BrandID INT UNSIGNED NOT NULL,
	PS_Count SMALLINT UNSIGNED,
	PS_SizeEach FLOAT UNSIGNED,
	PS_Unit VARCHAR(2),
	
	EntryCreatedDate TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	DetailsVerified BOOL DEFAULT False,
	
	PRIMARY KEY (PID),
	FOREIGN KEY (BrandID) REFERENCES Brands(ID) ON DELETE RESTRICT ON UPDATE CASCADE
);

ALTER TABLE Products ADD FULLTEXT(PName);


CREATE TABLE ProductLinks (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID INT UNSIGNED NOT NULL,
	UPC BIGINT UNSIGNED,
	CIN BIGINT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,
	
	PRIMARY KEY (ID),
	FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (UPC), -- DUPLICATE "NULL" ALLOWED.
	UNIQUE (UPC, CIN, StoreID)
);

CREATE TABLE SimilarProducts (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID1 INT UNSIGNED NOT NULL,
	PID2 INT UNSIGNED NOT NULL,
	Relationship TINYINT UNSIGNED NOT NULL,

	PRIMARY KEY (ID),
	FOREIGN KEY (PID1) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (PID2) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (PID1, PID2)
);


CREATE TABLE Prices (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID INT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,

	FetchedAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, -- for data
	FetchedSession INT UNSIGNED NOT NULL, -- for UNIQUE constraint, arbitrary number.

	PricePence SMALLINT UNSIGNED NOT NULL,
	Available BOOL DEFAULT True,
	
	PRIMARY KEY (ID),
	FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (PID, StoreID, PricePence, FetchedSession)
);


CREATE TABLE Offers (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	StoreGivenID BIGINT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,
	OfferType TINYINT UNSIGNED NOT NULL DEFAULT 0,
	StartDate DATETIME,
	EndDate DATETIME,

	RequiresMembership BOOL,
	OnlineExclusive BOOL,
	
	PRIMARY KEY (ID),
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (StoreGivenID, StoreID)
);


CREATE TABLE OfferHolders (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	OfferID INT UNSIGNED NOT NULL,
	PID INT UNSIGNED NOT NULL,

	PRIMARY KEY (ID),
	FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (OfferID) REFERENCES Offers(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (OfferID, PID)
);


CREATE TABLE Labels (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID INT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,
	
	CreatedDate TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	UpdatedDate TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

	LabelType TINYINT UNSIGNED NOT NULL DEFAULT 0,
	Param1 TEXT NOT NULL,

	PRIMARY KEY (ID),
    FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (PID, StoreID, LabelType, Param1)
);


CREATE TABLE Keywords (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID INT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,
	PData TINYTEXT NOT NULL,
    
    PRIMARY KEY (ID),
	FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (PID, PData) -- DON'T CARE ABOUT STORE, JUST WANT NO DUPLICATE DATA.
);

ALTER TABLE Keywords ADD FULLTEXT(PData);


CREATE TABLE Images (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID INT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,
	SourceURL TEXT NOT NULL,
	IsPreferred BOOL DEFAULT False,
	
	PRIMARY KEY (ID),
	FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (SourceURL) -- TODO admin task, when selecting PreferredThumb delete others (at least duplicate PID StoreID), might exist due to scaling
);


CREATE TABLE Ratings (
	ID INT UNSIGNED AUTO_INCREMENT NOT NULL,
	PID INT UNSIGNED NOT NULL,
	StoreID TINYINT UNSIGNED NOT NULL,
	Average DECIMAL(8, 3) UNSIGNED NOT NULL,
	NVotes SMALLINT UNSIGNED NOT NULL,

	PRIMARY KEY (ID),
	FOREIGN KEY (PID) REFERENCES Products(PID) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (StoreID) REFERENCES Stores(ID) ON DELETE RESTRICT ON UPDATE CASCADE,
	UNIQUE (PID, StoreID)
);